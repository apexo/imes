<html>
<head>
	<title>IMES</title>
	<style type="text/css">
		#middle {
			overflow-y: scroll;
			overflow-x: hidden;
		}
		#search-result {
			overflow: hidden;
		}
		.album-track {
			padding:2px;
			padding-left:2em;
			background-color:#ddf;
			background-image: -webkit-linear-gradient(top, #ddf, #eef);
		}
		.album-label, .single-track {
			padding:2px;
			background-color:#ddf;
			line-height:150%;
			padding-left: 8px;
			background-image: -webkit-linear-gradient(top, #bbe, #ddf);
		}
		.album-label, .album-track, .single-track {
			cursor: pointer;
		}
		.album-label:hover, .album-track:hover, .single-track:hover {
			background-image: none;
			background-color: #8080ff;
		}
		.album-cover {
			float:left;
		}
		.album-tracklist {
			padding-left:160px
		}
		.album, .single-track, .filter {
			margin-right:4px;
		}
		.album, .single-track {
			clear: left;
		}
		.album {
			margin:2px;
			background-color: #ddf;
		}
		.filter {
			padding:2px;
			padding-left: 8px;
			line-height:150%;
			background-image: -webkit-linear-gradient(top, #bbe, #ddf);
		}
		#nav {
			padding:0px 8px 0px 2px;
			line-height:150%;
		}
		#nav a {
			padding-top: 2px;
			padding-bottom: 2px;
			text-shadow:1px 1px 5px #FFFFFF;
			color:black;
			text-decoration:none;
			background-color: #ddf;
		}
		#nav a.active {
			background-image: -webkit-linear-gradient(top, #bbe, #ddf);
		}
		.filter input {
			border:0;
			padding:2px;
		}
		#controls {
			display:inline-block;
			padding:2px;
			vertical-align:middle;
			padding-right:6px;
		}
		#controls img {
			margin: 0;
			padding: 0;
			border: 0;
			display: block;
			float: left;
			
		}
		body {
			margin: 0;
			overflow: hidden;
		}

	</style>
	<script type="text/javascript" src="layout.js"></script>
	<script type="text/javascript" src="remote.js"></script>
	<script type="text/javascript">

var currentSearchToken = 0;

function formatAlbumTrack(i, tracklist) {
	var label = "", tracknumber;
	if (i.tracknumber !== undefined) {
		label += i.tracknumber + ". ";
		tracknumber = parseInt(i.tracknumber);
		if (isNaN(tracknumber)) {
			tracknumber = 0;
		}
	} else {
		label += "??. ";
		tracknumber = 0;
	}

	if (i.artist && i.artist.length) {
		label += i.artist[0] + " - ";
	}

	if (i.title && i.title.length) {
		label += i.title[0];
	} else {
		label += i._id.substring(i._id.lastIndexOf("/"));
	}

	var track = document.createElement("div");
	track.classList.add("album-track");
	track.dataset.id = i._id;
	track.dataset.tracknumber = tracknumber;
	track.appendChild(document.createTextNode(label));

	var insertAfter = tracklist.lastElementChild;
	while (insertAfter && parseInt(insertAfter.dataset.tracknumber) > tracknumber) {
		insertAfter = insertAfter.previousElementSibling;
	}
	tracklist.insertBefore(track, insertAfter ? insertAfter.nextElementSibling : tracklist.firstElementChild);

	return track;
}

function formatAlbumName(i) {
	var result = i.album && i.album.length ? i.album[0] : "Unknown Album";
	if (i.discnumber && (i.discnumber > 1 || i.totaldiscs && i.totaldiscs > 1)) {
		result += " [Disc " + i.discnumber + "]";
	}
	return result;
}

function scaledSize(img, max_width, max_height) {
	var ww = img.w * max_height;
	var hh = img.h * max_width;
	var nw, nh;
	if (ww < hh) {
		nw = (ww * 2 + img.h) / (2 * img.h);
		nh = max_height;
	} else if (hh < ww) {
		nw = max_width;
		nh = (hh * 2 + img.w) / (2 * img.w);
	} else {
		nw = max_width;
		nh = max_height;
	}
	return {w: nw, h: nh};
}

var THUMB_WIDTH = 160;
var THUMB_HEIGHT = 160;

function doSearch(terms) {
	currentSearchToken += 1;
	var mySearchToken = currentSearchToken;

	var target = document.querySelector("#search-result");
	var remote = new Remote(target);
	var view = remote.getView(terms);
	var page = 10;
	var pending = {};
	var offset = 0;
	var offset2 = 0;
	var lastPath = null, lastAlbumName = null, lastAlbumContainer = null, lastI = null, lastT = null;
	var placeHolder = document.createElement("div");
	placeHolder.style.height = Math.floor(target.parentElement.offsetHeight / 2);
	placeHolder.style.visibility = "hidden";

	target.innerHTML = "";
	target.appendChild(placeHolder);

	function addCover(target, info) {
		if (!info.pictures || !info.pictures.length) {
			return;
		}
		var p = info.pictures[0];
		var formats = [];
		//console.log(p);
		for (var key in p.formats) {
			if (p.formats.hasOwnProperty(key)) {
				var f = p.formats[key];
				var ss = scaledSize(f, THUMB_WIDTH, THUMB_HEIGHT);
				formats.push([!(f.w > ss.w && f.h > ss.h), f.w*f.h, f, ss]);
			}
		}
		formats.sort();
		var f = formats[0][2];
		var ss = formats[0][3];
		//console.log(f);
		var cover = document.createElement("img");
		cover.classList.add("album-cover");
		cover.width = ss.w;
		cover.height = ss.h;
		cover.src = DB_URL + DB_PREFIX + "picture/" + p.key + "/" + f.f;
		target.appendChild(cover);
	}

	function doProcess(info) {
		var i = info.data;
		var t = info.target;
		var album = i.album && i.album.length ? i.album[0] : "";
		var artist = i.artist && i.artist.length ? i.artist[0] : "";
		var title = i.title && i.title.length ? i.title[0] : "";
		var path = i._id.substring(0, i._id.lastIndexOf("/"));
		var disc = i.discnumber;

		if (!album || path !== lastPath || album !== lastAlbumName || disc !== lastDisc) {
			lastAlbumContainer = null;
			lastAlbumName = album;
			lastI = i;
			lastT = t;
			lastPath = path;
			lastDisc = disc;

			if (album) {
				t.firstChild.textContent = "[" + album + "] " + artist + " - " + title;
			} else {
				t.firstChild.textContent= artist + " - " + title;
			}
			//console.log(info.data);
			return;
		}

		if (!lastAlbumContainer) {
			lastAlbumContainer = document.createElement("div");
			lastAlbumContainer.classList.add("album");
			var label = document.createElement("div");
			label.classList.add("album-label");
			label.appendChild(document.createTextNode(formatAlbumName(i)));
			lastAlbumContainer.appendChild(label);
			addCover(lastAlbumContainer, i);
			var tracklist = document.createElement("div");
			tracklist.classList.add("album-tracklist");
			lastAlbumContainer.appendChild(tracklist);

			t.parentElement.insertBefore(lastAlbumContainer, t);
		}

		var tracklist = lastAlbumContainer.querySelector(".album-tracklist");

		if (lastI) {
			lastT.parentElement.removeChild(lastT);
			formatAlbumTrack(lastI, tracklist);
			lastI = lastT = null;
		}

		t.parentElement.removeChild(t);
		formatAlbumTrack(i, tracklist);

		var target = info.target;
		//console.log(info.data);
	}

	function process(d, i, data) {
		if (currentSearchToken !== mySearchToken) {
			return;
		}
		if (offset2 !== i) {
			pending[i] = {target: d, data: data};
			return;
		}
		doProcess({target: d, data: data});
		offset2 += 1;
		i += 1;
		while (pending.hasOwnProperty(i)) {
			doProcess(pending[i]);
			delete pending[i];
			i += 1;
			offset2 += 1;
		}
		maybeResume();
	}

	function getInfo(d, id, i) {
		var j = i + offset;
		get_file_info(id, function(data) {
			process(d, j, data);
		});
	}

	var state = "loading";
	var scrollParent = target.parentElement;

	function resume(ids) {
		if (currentSearchToken !== mySearchToken) {
			return;
		}
		for (var i = 0; i < ids.length; i++) {
			if (ids[i] === null) {
				target.removeChild(placeHolder);
				scrollParent.onscroll = null;
				state = "done";
				return;
			}
			var d = document.createElement("div");
			d.classList.add("single-track");
			d.appendChild(document.createTextNode(ids[i]));
			target.insertBefore(d, placeHolder);
			getInfo(d, ids[i], i);
		}
		offset += ids.length;
		if (placeHolder.offsetTop - scrollParent.scrollTop < scrollParent.offsetHeight) {
			view.fetch(resume, page);
		} else {
			state = "paused";
		}
	}

	scrollParent.onscroll = function() {
		if (currentSearchToken !== mySearchToken) {
			console.log("stale onscroll handler", currentSearchToken, mySearchToken, state, scrollParent);
			return;
		}

		if (state === "paused") {
			if (placeHolder.offsetTop - scrollParent.scrollTop < scrollParent.offsetHeight) {
				state = "loading";
				view.fetch(resume, page);
			}
		}
	}
	scrollParent.onscroll.token = mySearchToken;

	view.fetch(resume, page);
}

function maybeResume() {
	var middle = document.querySelector("#middle");
	if (middle.onscroll) {
		middle.onscroll();
	}
}

function enqueueTracks(ids) {
	console.log("TODO", "enqueue", ids);
}

function onLoad() {
	setTimeout(function() {
		new ViewportLayout(document.body, new VBoxLayout(document.body));
		new HBoxLayout(document.querySelector("#top .filter"));
	
		layoutManager.layout();
		window.onresize = function() {
			layoutManager.layout();
			maybeResume();
		};
		document.querySelector("#search-result").addEventListener("click", function(event) {
			var target = event.target;
			var cl = target.classList;
			if (cl.contains("album-track")) {
				enqueueTracks([target.dataset.id]);
			} else if (cl.contains("album-label")) {
				var ids = [];
				var tracks = target.parentElement.querySelectorAll(".album-track");
				for (var i = 0; i < tracks.length; i++) {
					var t = tracks[i];
					ids.push(t.dataset.id);
				}
				enqueueTracks(ids);
			} else if (cl.contains("single-track")) {
				enqueueTracks([target.dataset.id]);
			} else {
				return;
			}
			event.stopPropagation();
			event.preventDefault();
		}, false);

		setTimeout(function() {
			doSearch("");
		}, 500);
	}, 0);
}

	</script>
</head>
<body onload="onLoad()">
	<div id="nav">
		<a href="" class="active">Search</a>
		<a href="">Playlist</a>
		<a href="">Settings</a>
	</div>
	<div id="top">
		<div class="filter">
			<label for="search-terms" accesskey="F">Filter</label>
			<input class="search" id="search-terms" name="search-terms" data-weight="1" onInput="doSearch(this.value)"></input>
			<div id="controls">
				<img height="20" width="20" />
				<img height="20" width="20" />
			</div>
		</div>
	</div>
	<div id="middle" data-weight="1">
		<div id="search-result">
		</div>
	</div>
	<div id="bottom"></div>
</body>
</html>
